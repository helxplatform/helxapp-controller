{{- define "podMetadata" }}
metadata:
  name: {{ .system.Name }}
  labels:
    name: {{ .system.Name }}
    username: {{ .system.Username }}
    app-name: {{ .system.AppName }}
    original-app-name: {{ .system.AppName }}
    reaper-label: {{ .system.AppName }}
    executor: helxapp-controller
    helxapp-guid: {{ .system.Identifier }}
    helxapp-app-id: {{ .system.AppName }}
{{- end -}}

{{- define "containerList" }}
{{- with $dot := . }}
{{- range $index,$container := .system.Containers }}
{{- with $context := dict "system" $dot.system "container" $container }}
- name: {{ $container.Name }}
  {{- if or $container.SecurityContext.RunAsUser $container.SecurityContext.RunAsGroup $container.SecurityContext.FsGroup }}
  {{- template "securityContext" $container.SecurityContext }}
  {{- end }}
  {{- if $container.Command }}
  command: {{ $container.Command }}
  {{- end }}
  {{- templateToString "containerEnv" $context | indent 2 }}
  image: {{ $container.Image }}
  {{- templateToString "containerPorts" $context | indent 2 }}
  {{- templateToString "containerResources" $context | indent 2 }}
  {{- templateToString "containerLivenessProbe" $context | indent 2 }}
  {{- templateToString "containerReadinessProbe" $context | indent 2 }}
  {{- templateToString "containerVolumeMounts" $container | indent 2 }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{- define "podProps" }}
  {{- if hasGPU .system.Containers -}}
  {{- template "gpuTolerations" . }}
  {{- end -}}
  {{- if or .system.SecurityContext.RunAsUser .system.SecurityContext.RunAsGroup .system.SecurityContext.FsGroup -}}
  {{- template "securityContext" .system.SecurityContext }}
  {{- end -}}
  {{- if and (ge (len .system.InitContainers) 0) .system.CreateHomeDirs -}}
  {{- template "initContainer" . }}
  {{- end -}}
{{- end -}}

{{- define "podVolumes" }}
{{- if gt (len .system.Volumes) 0 }}
volumes:
  {{- range $name,$volume := .system.Volumes }}
  - name: {{ $volume.Name }}
    {{- if eq $volume.Scheme "pvc" }}
    persistentVolumeClaim:
      claimName: {{ $volume.Attr.claim }}
    {{- else if eq $volume.Scheme "nfs" }}
    nfs:
      server: {{ $volume.Attr.server }}
      path: {{ $volume.Attr.path }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{- define "podSpec" }}
spec:
  {{- template "podProps" . }}
  containers:
  {{- templateToString "containerList" . | indent 4 }}
  {{- templateToString "podVolumes" . | indent 2 }}
{{- end }}
